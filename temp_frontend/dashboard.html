<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sphere Finance - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .navbar {
      background: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-name {
      font-weight: 600;
      color: #333;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-logout {
      background: #fee;
      color: #c33;
    }

    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 40px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      color: #999;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .card-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }

    .card-value.green {
      color: #10b981;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .account-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #667eea;
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .account-name {
      font-weight: 600;
      font-size: 16px;
      color: #333;
    }

    .account-type {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
    }

    .account-balance {
      font-size: 28px;
      font-weight: bold;
      color: #10b981;
    }

    .bank-name {
      font-size: 12px;
      color: #667eea;
      margin-top: 8px;
    }

    .transactions-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .transaction-row {
      display: grid;
      grid-template-columns: 1fr 150px 120px 100px;
      padding: 15px 20px;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
    }

    .transaction-row:hover {
      background: #f9f9f9;
    }

    .transaction-name {
      font-weight: 600;
      color: #333;
    }

    .transaction-merchant {
      font-size: 13px;
      color: #999;
      margin-top: 3px;
    }

    .transaction-category {
      font-size: 12px;
      color: #667eea;
      background: #eef;
      padding: 4px 10px;
      border-radius: 12px;
      display: inline-block;
    }

    .transaction-date {
      color: #999;
      font-size: 14px;
    }

    .transaction-amount {
      font-weight: bold;
      font-size: 16px;
      text-align: right;
    }

    .transaction-amount.positive {
      color: #10b981;
    }

    .transaction-amount.negative {
      color: #ef4444;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #10b981;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      display: none;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: block;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .bills-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 40px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .bill-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .bill-item.last {
      border-bottom: none;
    }

    .bill-info {
      flex: 1;
    }

    .bill-frequency {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      margin-top: 5px;
    }

    .bill-amount {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      min-width: 100px;
      text-align: right;
    }

    .bill-due {
      font-size: 14px;
      color: #10b981;
      text-align: right;
    }

    .overdue {
      color: #ef4444;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">üí∞ Sphere Finance</div>
    <div class="user-menu">
      <span class="user-name" id="user-name">Loading...</span>
      <button class="btn btn-secondary" id="refresh-btn">üîÑ Refresh</button>
      <button class="btn btn-logout" id="logout-btn">Logout</button>
    </div>
  </nav>

  <div class="container">
    <div class="loading show" id="loading">
      <div class="spinner"></div>
      <p>Loading your financial data...</p>
    </div>

    <div id="main-content" style="display: none;">
      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="card">
          <div class="card-title">Total Balance</div>
          <div class="card-value green" id="total-balance">$0.00</div>
        </div>
        <div class="card">
          <div class="card-title">Accounts</div>
          <div class="card-value" id="account-count">0</div>
        </div>
        <div class="card">
          <div class="card-title">Transactions</div>
          <div class="card-value" id="transaction-count">0</div>
        </div>
        <div class="card">
          <div class="card-title">Connected Banks</div>
          <div class="card-value" id="bank-count">0</div>
        </div>
      </div>

      <!-- Accounts Section -->
      <div class="section-header">
        <h2 class="section-title">Your Accounts</h2>
        <button class="btn btn-primary" id="connect-bank-btn">+ Connect Bank</button>
      </div>

      <div class="accounts-grid" id="accounts-grid">
        <!-- Accounts will be inserted here -->
      </div>

      <!-- Transactions Section -->
      <div class="section-header">
        <h2 class="section-title">Recent Transactions</h2>
      </div>

      <div class="transactions-table" id="transactions-table">
        <!-- Transactions will be inserted here -->
      </div>

      <!-- Bills Section -->
      <div class="bills-section" id="bills-section">
        <!-- Upcoming bills will be inserted here -->
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Initialize Supabase - use window.supabase from CDN
    const SUPABASE_URL = 'https://dvzwvyjdsrgcgnvejbhs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2end2eWpkc3JnY2dudmVqYmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTU4MzAsImV4cCI6MjA4MzQ5MTgzMH0.WzE4suOD63FzmyLPJEffr1kGCM7OOOoDhqj-G-kmLJk';
    const API_URL = 'https://d1959890d7c7.ngrok-free.app';
    
    // The CDN exposes supabase on window.supabase
    const { createClient } = window.supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentSession = null;
    let authToken = null;

    // Check authentication
    async function checkAuth() {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      
      if (!session) {
        window.location.href = 'auth.html';
        return false;
      }

      currentSession = session;
      authToken = session.access_token;
      
      // Display user name
      const userName = session.user.user_metadata?.full_name || session.user.email;
      document.getElementById('user-name').textContent = userName;

      return true;
    }

    // API helper
    async function apiCall(endpoint, options = {}) {
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers,
        },
      });

      if (!response.ok) {
        throw new Error(`API call failed: ${response.statusText}`);
      }

      return response.json();
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load summary
        const summary = await apiCall('/api/summary');
        document.getElementById('total-balance').textContent = 
          `$${summary.totalBalance.toFixed(2)}`;
        document.getElementById('account-count').textContent = summary.accountCount;
        document.getElementById('transaction-count').textContent = summary.transactionCount;
        document.getElementById('bank-count').textContent = summary.connectedBanks;

        // Load accounts
        const accounts = await apiCall('/api/accounts');
        displayAccounts(accounts);

        // Load transactions
        const transactions = await apiCall('/api/transactions?limit=50');
        displayTransactions(transactions);

        // Load bills
        await loadBills();

        // Show content
        document.getElementById('loading').classList.remove('show');
        document.getElementById('main-content').style.display = 'block';
      } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Error loading data. Please try again.', 'error');
        document.getElementById('loading').classList.remove('show');
        document.getElementById('main-content').style.display = 'block';
      }
    }

    // Display accounts
    function displayAccounts(accounts) {
      const grid = document.getElementById('accounts-grid');
      
      if (accounts.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">üè¶</div>
            <h3>No accounts connected yet</h3>
            <p>Click "Connect Bank" to get started</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = accounts.map(account => `
        <div class="account-card">
          <div class="account-header">
            <div>
              <div class="account-name">${account.name}</div>
              <div class="account-type">${account.subtype || account.type}</div>
            </div>
          </div>
          <div class="account-balance">$${parseFloat(account.current_balance || 0).toFixed(2)}</div>
          <div class="bank-name">${account.plaid_items?.institution_name || 'Bank'}</div>
        </div>
      `).join('');
    }

    // Display transactions
    function displayTransactions(transactions) {
      const table = document.getElementById('transactions-table');
      
      if (transactions.length === 0) {
        table.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3>No transactions yet</h3>
            <p>Transactions will appear here once you connect your bank</p>
          </div>
        `;
        return;
      }

      table.innerHTML = transactions.map(tx => {
        const isNegative = tx.amount > 0;
        const category = tx.primary_category || 'Other';
        
        return `
          <div class="transaction-row">
            <div>
              <div class="transaction-name">${tx.name}</div>
              ${tx.merchant_name ? `<div class="transaction-merchant">${tx.merchant_name}</div>` : ''}
            </div>
            <div>
              <span class="transaction-category"">${category}</span>
            </div>
            <div class="transaction-date">${new Date(tx.date).toLocaleDateString()}</div>
            <div class="transaction-amount ${isNegative ? 'negative' : 'positive'}">
              ${isNegative ? '-' : '+'}$${Math.abs(tx.amount).toFixed(2)}
            </div>
          </div>
        `;
      }).join('');
    }

    // Load and display bills
    async function loadBills() {
      try {
        const bills = await apiCall('/api/bills');
        window._billsCache = bills; 
        displayBills(bills);
      } catch (error) {
        console.error('Error loading bills:', error);
      }
    }

    function updateDateRange() {
      const selector = document.getElementById('dateRangeSelector');
      const dateRange = parseInt(selector.value, 10);
      displayBills(window._billsCache, dateRange);
    }

    function displayBills(bills, dateRange = 7) {
      console.log('Displaying bills with date range:', dateRange);
      bills = bills.map(bill => ({
        ...bill,
        is_upcoming: bill.days_until_due >= 0 && bill.days_until_due <= dateRange // queryable
      }));

      const upcomingBills = bills.filter(b => b.is_upcoming);
      
      if (upcomingBills.length === 0) return;

      const billsHTML = `
        <div class="bills-section">
          <h3>Upcoming Bills</h3>
          <select id="dateRangeSelector" onchange="updateDateRange()">
            <option value="7" ${dateRange === 7 ? 'selected' : ''}>Next 7 days</option>
            <option value="14" ${dateRange === 14 ? 'selected' : ''}>Next 14 days</option>
            <option value="30" ${dateRange === 30 ? 'selected' : ''}>Next 30 days</option>
          </select>
          ${upcomingBills.map(bill => `
            <div class="bill-item ${bill.is_overdue ? 'overdue' : ''}">
              <div class="bill-info">
                <strong>${bill.description || bill.merchant_name}</strong>
                <span class="bill-frequency">${bill.frequency}</span>
              </div>
              <div class="bill-amount">$${Math.abs(bill.average_amount).toFixed(2)}</div>
              <div class="bill-due">
                ${bill.is_overdue 
                  ? `<span class="overdue">Overdue by ${Math.abs(bill.days_until_due)} days</span>`
                  : `Due in ${bill.days_until_due} days`
                }
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      // Insert before accounts section
      if(document.querySelector('.bills-section')) {
        document.querySelector('.bills-section').remove();
      }
      const container = document.querySelector('.container');
      container.insertAdjacentHTML('afterbegin', billsHTML);
    }

    // Connect bank with Plaid
    document.getElementById('connect-bank-btn').addEventListener('click', async () => {
      try {
        const { link_token } = await apiCall('/api/create_link_token', { method: 'POST' });

        const handler = Plaid.create({
          token: link_token,
          onSuccess: async (public_token, metadata) => {
            try {
              showToast('Connecting your bank...');
              
              await apiCall('/api/exchange_public_token', {
                method: 'POST',
                body: JSON.stringify({ public_token }),
              });

              showToast('Bank connected successfully!');
              
              // Reload dashboard
              setTimeout(() => {
                location.reload();
              }, 1500);
            } catch (error) {
              console.error('Error exchanging token:', error);
              showToast('Error connecting bank. Please try again.', 'error');
            }
          },
          onExit: (err, metadata) => {
            if (err) {
              console.error('Plaid Link error:', err);
            }
          },
        });

        handler.open();
      } catch (error) {
        console.error('Error creating link token:', error);
        showToast('Error opening Plaid Link. Please try again.', 'error');
      }
    });

    // Refresh data
    document.getElementById('refresh-btn').addEventListener('click', async () => {
      try {
        showToast('Refreshing your data...');
        await apiCall('/api/refresh', { method: 'POST' });
        showToast('Data refreshed successfully!');
        
        // Reload dashboard
        setTimeout(() => {
          location.reload();
        }, 1500);
      } catch (error) {
        console.error('Error refreshing:', error);
        showToast('Error refreshing data. Please try again.', 'error');
      }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      window.location.href = 'auth.html';
    });

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Initialize
    (async () => {
      const isAuthenticated = await checkAuth();
      if (isAuthenticated) {
        await loadDashboard();
      }
    })();
  </script>
</body>
</html>